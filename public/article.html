<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <link rel="stylesheet" href="/css/articleTable.css">
        <title>Document</title>
        <style>
            .title {
                display: block;
                width: 100px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        </style>
    </head>
    <body>
        <button onclick="history.back()">返回</button>
        <h3>文章管理</h3>
        <a href="/admin/article/articleEdit?edit=add">添加文章</a>
        <a href="/admin/article/articleEdit?edit=update">更新文章</a>
        <div class="search">
            <input type="text" />
            <button type="button">搜索</button>
        </div>
        <select name="pid" id="" class="pid">
            <option value="0">未分类</option>
        </select>
        <select name="classType" class="classType">
            <option value="0">普通文章</option>
            <option value="1">缩率图文章</option>
            <option value="2">广告位文章</option>
        </select>
        <table border="1" class="box">
            <thead>
                <!-- th相当于td , 但是带有标题的含义 -->
                <tr>
                    <th>ID</th>
                    <th>标题</th>
                    <th>作者</th>
                    <th>状态</th>
                    <th>类型</th>
                    <th>图片</th>
                    <th>浏览量</th>
                    <th>发布时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="boxBtn"></div>
    </body>
    <script src="/jQuery/jquery-3.4.1.js"></script>
    <!-- <script src="/js/article.js"></script> -->
    <script>
        let searchBtn = $('.search button'),
            searchInp = $('.search input'),
            pid = $('.pid'),
            classType = $('.classType'),
            boxTbody = $('.box tbody'),
            boxBtn = $('.boxBtn'),
            searchType = { select: 'all', value: '', page: 1 }, // 默认搜索类型为 all 空 1
            delBtn = $('.delBtn');

        (() => {
            $.ajax({
                url: '/admin/nav/navSelect',
                async: false,
                success: function(data) {
                    pid.html(`<option value="-1">未分类</option>${data}`);
                }
            });
        })();

        const appendTag = (data, tag) => {
            for (let i in data) {
                $.each($(data[i]), (k, v) => {
                    tag.append(
                        `<tr>
                            <td>${v.id}</td>
                            <td class="title">${v.title}</td>
                            <td>${v.author}</td>
                            <td>${v.navStatus == '0' ? '草稿' : '发布'}</td>
                            <td>
                                ${['普通文章', '缩略图文章', '广告位文章'][v.classType]}
                            </td>
                            <td>
                                ${v.img != 'null' ? '<img src=/' + v.img + '>' : '无'}
                            </td>
                            <td>${v.readNum}</td>
                            <td>${new Date(v.time).toLocaleDateString()}</td>
                            <td>
                                <a href="/admin/article/articleEdit?edit=update&id=${v.id}">
                                    编辑
                                </a>
                                <button class="delBtn" id="${v.id}" img_path="${v.img_path}">
                                    删除
                                </button>
                            </td>
                        </tr>`
                    )
                        .find('button:last')
                        .click(function() {
                            $.ajax({
                                url: '/admin/article/articleDel',
                                data: {
                                    id: $(this).attr('id'),
                                    img_path: $(this).attr('img_path')
                                },
                                success: function(data) {
                                    if (data == 'articleDel succeed') {
                                        alert('文章删除成功');
                                        location.href = '/admin/article';
                                    } else {
                                        alert('文章删除失败');
                                    }
                                }
                            });
                        });
                });
            }
        };

        const select = datas => {
            console.log(datas);
            $.ajax({
                url: `/admin/article/articleGet`,
                data: datas,
                success: function(data) {
                    console.log(data);
                    boxTbody.html(''); // 清空列表
                    if (data.sqlData) {
                        appendTag(data.sqlData, boxTbody);
                        boxBtn.html(''); // 清空按钮
                        let pages = data.pagings.pageList;
                        for (let i in pages) {
                            boxBtn.append(
                                $(`<button>${pages[i]}</button>`)
                                    .click(function() {
                                        searchType.page = pages[i];
                                        select(searchType);
                                    })
                                    .css({
                                        backgroundColor:
                                            pages[i] == data.pagings.page ? 'red' : 'green'
                                    })
                            );
                        }
                    } else {
                        boxTbody.append(`<td colspan="9">无数据</td>`);
                    }
                }
            });
        };
        select(searchType);

        searchBtn.click(function() {
            searchType.select = 'title';
            searchType.value = searchInp.val();
            select(searchType);
        });

        pid.change(function() {
            searchType.select = 'pid';
            searchType.value = $(this).val();
            select(searchType);
        });

        classType.change(function() {
            searchType.select = 'classType';
            searchType.value = $(this).val();
            select(searchType);
        });
    </script>
</html>
